# 2 旋转矩阵

将一般旋转矩阵表达的姿态拆解成3次旋转角度
**注意事项:**

- 旋转具有顺序性, 多次旋转的先后顺序需要明确定义
- 旋转转轴也需要明确定义, 是对某固定的轴旋转或是对转动的坐标系当下所在的转轴旋转?

于是介绍两种拆解方式

## 2.1 针对固定转轴的转动

三个矩阵的连乘, 先转的放在后面, 旋转矩阵应当左乘.

假如首先针对 $\{X\}$ 轴转动 $\gamma$ 度, 然后针对 $\{Y\}$ 轴转动 $\beta$ 度, 最后针对 $\{Z\}$ 轴转动 $\alpha$ 度, 则有

$$
{}_{B}^{A}R_{XYZ} \left( \gamma, \beta, \alpha \right)=R_{Z} \left( \alpha \right) R_{Y} \left( \beta \right) R_{X} \left( \gamma \right)
$$
$$
=\begin{bmatrix}c\alpha&-s\alpha&0\\ s\alpha&c\alpha&0\\ 0&0&1\end{bmatrix}\begin{bmatrix}c\beta&0&s\beta\\ 0&1&0\\ -s\beta&0&c\beta\end{bmatrix}\begin{bmatrix}1&0&0\\ 0&c\gamma&-s\gamma\\ 0&s\gamma&c\gamma\end{bmatrix}
$$
$$
= \left[ \begin{matrix} c \alpha c \beta&c \alpha s \beta s \gamma-s \alpha c \gamma&c \alpha s \beta c \gamma+s \alpha s \gamma \\ s \alpha c \beta&s \alpha s \beta s \gamma+c \alpha c \gamma&s \alpha s \beta c \gamma-c \alpha s \gamma \\ -s \beta&c \beta s \gamma&c \beta c \gamma \end{matrix} \right]
$$

## 2.2 由旋转矩阵反解各轴旋转角度

$$
{}^{A}_{B}R_{_{XYZ}}(\gamma,\beta,\alpha)=
\begin{bmatrix}
c\alpha c\beta&c \alpha s\beta s\gamma-s\alpha c\gamma&c\alpha s\beta c\gamma+s\alpha s\gamma \\
s\alpha c\beta&s\alpha s\beta s\gamma+c\alpha c\gamma&s\alpha s\beta c\gamma-c \alpha s\gamma\\
-s\beta&c\beta s\gamma&c\beta c\gamma
\end{bmatrix}=
\begin{bmatrix}
r_{11}&r_{12 }&r_{13}\\
r_{21}&r_{22}&r_{23}\\ r_{31}&r_{32}&r_{33}\end{bmatrix}
$$

1. 假设中间角度 $\beta \neq 90 ^{\circ}$ (若等于则解不唯一)
   $$
   \begin{split}\beta&=Atan2 \left(-r_{31}, \sqrt{r_{11}^{2}+r_{21}^{2}} \right) \\ \alpha&=Atan2 \left( r_{21}/c \beta,r_{11}/c \beta \right) \\ \gamma&=Atan2 \left( r_{32}/c \beta,r_{33}/c \beta \right) \end{split}
   $$

   PS: $Atan2$ 为反正切函数, 且 $\alpha$ 在 $\left[ -\pi, \pi \right]$ 范围内

1. 若中间角度 $\beta = 90 ^{\circ}$
   则 $\alpha=0$ , $\gamma=Atan2(r_{12},r_{22})$
1. 若中间角度 $\beta = -90 ^{\circ}$
   则 $\alpha=0$ , $\gamma=-Atan2(r_{12},r_{22})$

## 2.3 针对转动转轴的旋转

先转的放在前面, 后转的放在后面, 旋转矩阵应当右乘.

$$
{}_{B}^{A}R_{Z^{\prime}Y^{\prime}X^{\prime}}(\alpha,\beta,\gamma)={}_{B^{\prime}}^{A}R_{B^{\prime\prime}}^{B^{\prime}}R{}_{B}^{B^{\prime\prime}}R=R_{Z^{\prime}}(\alpha)R_{Y^{\prime}}(\beta)R_{X^{\prime}}(\gamma)
$$

$$=
\begin{bmatrix}
c\alpha & -s\alpha & 0 \\
s\alpha & c\alpha & 0 \\
0 & 0 & 1
\end{bmatrix}
\begin{bmatrix}
c\beta & 0 & s\beta \\
0 & 1 & 0 \\
-s\beta & 0 & c\beta
\end{bmatrix}
\begin{bmatrix}
1 & 0 & 0 \\
0 & c\gamma & -s\gamma \\
0 & s\gamma & c\gamma
\end{bmatrix}
$$

$$
=R_{Z}(\alpha)R_{Y}(\beta)R_{X}(\gamma)={}_{B}^{A}R_{XYZ}(\gamma,\beta,\alpha)
$$

即: 针对转动转轴(Euler Angles)的旋转恰好是针对固定转轴(Fix Angles)的反序旋转.

## 2.4 由旋转矩阵反解各轴旋转角度（ZYZ公式）

先对 $Z$ 转 $\alpha$ , 再对 $Y$ 转 $\beta$, 最后对 $Z$ 转 $\gamma$ .

$$
{}^{A}_{B}R_{Z^{^{\prime}}Y^{^{\prime}}Z^{^{\prime}}}(\alpha,\beta, \gamma)=\begin{bmatrix}
c\alpha c\beta c\gamma -s\alpha s\gamma&-c\alpha c \beta s\gamma -s\alpha c\gamma&c\alpha s\beta\\
s\alpha c\beta c\gamma +c\alpha s\gamma&-s\alpha c\beta s\gamma+c\alpha c \gamma&s\alpha s\beta\\
-s\beta c\gamma&s\beta s\gamma&c\beta\end{bmatrix}=\begin{bmatrix}r_{11}&r_{12 }&r_{13}\\
r_{21}&r_{22}&r_{23}\\
r_{31}&r_{32}&r_{33}
\end{bmatrix}
$$

1. 假设中间角度$\beta \neq 0 ^{\circ}$, 则有
   $\beta=Atan2(\sqrt{r_{31}^{2}+r_{32}^{2}},r_{33})$
   $\alpha=Atan2(r_{23}/s\beta,r_{13}/s\beta)$
   $\gamma=Atan2(r_{32}/s\beta,-r_{31}/s\beta)$

1. 若中间角度 $\beta = 0 ^{\circ}$
   $\alpha = 0$ , $\gamma=Atan2(-r_{12},r_{11})$

1. 若中间角度 $\beta = 180 ^{\circ}$
   $\alpha = 0$ , $\gamma=Atan2(r_{12},-r_{11})$

## 2.5 小结

- Euler/Fixed angles

  - 12种Euler angles和12种Fixed angles
  - 存在Duality 共12种对principal axes连三次转动的拆解方法

## 2.6 整合表达刚体的状态

### 2.6.1 向量在不同坐标系下的映射

- 仅有移动
  $$
  {}^{A}P = {}^{B}P + {}^{A}P_{B\text{ \textit{org}}}
  $$
- 仅有转动
  $$
  {}^{A}P = {}^{A}_{B}R^{B}P
  $$
- 转动和移动复合
  (先转动再移动)
  $$
  {}^AP = {}^{A}_{B}R {}^{B}P + {}^{A}P_{B\text{ \textit{org}}}
  $$
  $$
  \left[\begin{matrix}
  {}^{A}P\\
  1
  \end{matrix}\right]=
  \left[\begin{matrix}
  &{}^{A}_{B}R && {}^{A}P_{B\text{ \textit{org}}}\\
  0&0&0&1
  \end{matrix}\right]
  \left[\begin{matrix}
  {}^{B}P\\
  1
  \end{matrix}\right]=
  \left[\begin{matrix}
  {}^{A}_{B}R^{B}P+{}^{A}P_{B\text{ \textit{org}}}\\
  1
  \end{matrix}\right]
  $$

- 可连续操作
  ${}_B^AT={}_C^AT{}_D^CT{}_B^DT$

### 2.6.2 对向量进行移动或转动

- 仅有移动
  $$
  {}^{A}P_{2} = {}^{A}P_{1} + {}^{A}Q
  $$

  $$
  \begin{bmatrix}
  {}^{A}P_{2}\\
  1
  \end{bmatrix}=
  D(Q)
  \begin{bmatrix}
  {}^{A}P_{1}\\
  1
  \end{bmatrix}=
  \begin{bmatrix}
  &I&&{}^{A}Q\\
  0&0&0&1
  \end{bmatrix}
  \begin{bmatrix}
  {}^{A}P_{1}\\
  1
  \end{bmatrix}=
  \begin{bmatrix}
  {}^{A}P_{1}+{}^{A}Q\\
  1
  \end{bmatrix}
  $$

- 仅有转动
  $$
  {}^{A}P_{2} = R_{\hat{K}}(\theta) {}^{A}P_{1}
  $$

  $$
  \begin{bmatrix}
  {}^{A}P_{2}\\
  1
  \end{bmatrix}=
  \begin{bmatrix}
  &0\\
  R_{\vec{K}}(\theta)&0\\
  &0\\
  0\quad 0\quad 0&1
  \end{bmatrix}
  \begin{bmatrix}
  {}^{A}P_{1}\\
  1
  \end{bmatrix}=
  \begin{bmatrix}
  R_{\vec{K}}(\theta){}^{A}P_{1}\\
  1\end{bmatrix}
  $$

- 移动和转动的复合
  (先转动再移动)
  $$
  {}^{A}P_{2} = R_{\hat{K}}(\theta){}^{A}P_{1} + {}^{A}Q
  $$

  $$
  \begin{bmatrix}
  {}^{A}P_{2}\\ 1\end{bmatrix}=
  \begin{bmatrix}
  R_{\bar{K}}(\theta)&{}^{A}Q\\
  0\quad 0\quad 0\quad 1
  \end{bmatrix}
  \begin{bmatrix}
  {}^{A}P_{1}\\
  1
  \end{bmatrix}=
  \begin{bmatrix}
  R_{\bar{K}}(\theta){}^{A}P_{1}+{}^{A}Q\\
  1
  \end{bmatrix}=
  T
  \begin{bmatrix}
  {}^{A}P_{1}\\
  1
  \end{bmatrix}
  $$

- 运动是相对的, 对向量或点进行移动或者转动的操作, 也可以想成是对坐标系进行"反向"的移动或转动的操作

### 2.6.3 转换矩阵小结

- 三种用法
  1. 描述一个坐标系相对于另一个坐标系的空间状态
     $$
     {}_{B}^{A}T=
     \begin{bmatrix}
     |&|&|&|\\
     {}^{A}\hat{X}_{B} & ^{A}\hat{Y}_{B} & ^{A}\hat{Z}_{B} & ^{A}P_{B\text{ \textit{org}}}\\
     |&|&|&|\\
     0&0&0&1
     \end{bmatrix}
     $$

  1. 将点由某一个坐标系表达换到另一个坐标系来表达

     $$
     \begin{bmatrix}
     {}^{A}P \\
     1
     \end{bmatrix}=
     {}^{A}_{B}T
     \begin{bmatrix}
     {}^{B}P \\
     1
     \end{bmatrix}
     $$

  1. 将点在同一个坐标系中进行移动和转动

     $$
    \begin{bmatrix}
     {}^{A}P_{2} \\
     1
     \end{bmatrix}=
     T
     \begin{bmatrix}
     {}^{A}P_{1}\\
     1
     \end{bmatrix}
     $$

### 2.6.4 转换矩阵的运算

- 连续运算
  
  $$
  {}^{A}P={}_{B}^{A}T^{B}P={}_{B}^{A}T({}_{C}^{B}T^{C}P)={}_{B}^{A}T{}_{C}^{B}T^{C}P
  $$
  $$=
  \begin{bmatrix}
  &{}^{A}_{B}R && {}^{A}P_{B\ org}\\
  0&0&0&1
  \end{bmatrix}
  \begin{bmatrix}
  &{}^{B}_{C}R && {}^{B}P_{C\ org}\\
  0&0&0&1
  \end{bmatrix}
  $$
  $$=
  \begin{bmatrix}
  &{}^{A}_{B}R{}^{B}_{C}R && {}^{A}P_{B\ org}+{}^{A}_{B}R{}^{B}P_{C\ org}\\
  0&0&0&1
  \end{bmatrix}=
  {}^{A}_{C}T \, {}^{C}P
  $$

- 反矩阵
  ${}^{A}_{B}T{}^{B}_{A}T = {}^{A}_{B}T{}^{A}_{B}T^{-1} = I$

  $$
  \begin{bmatrix}
  & {}_{B}^{A}R & & {}^{A}P_{Borg} \\
  0 & 0 & 0 & 1
  \end{bmatrix}
  \begin{bmatrix}
  & {}_{A}^{B}R & & {}^{B}P_{Aorg} \\
  0 & 0 & 0 & & 1
  \end{bmatrix}
  $$

  $$=
  \begin{bmatrix}
  &{}^{A}_{B}R{}^{B}_{A}R && {}^{A}P_{B\ org}+{}^{A}_{B}R{}^{B}P_{A\ org}\\
  0&0&0&1
  \end{bmatrix}=
  \begin{bmatrix}
  &&& 0 \\
  &I_{3} && 0 \\
  &&& 0 \\
  0&0&0&1
  \end{bmatrix}
  =I_{4}
  $$

  ${}^{A}_{B}R{}^{B}_{A}R = I_{3} \Rightarrow {}^{B}_{A}R = {}^{A}_{B}R^{T}$

  ${}^{A}P_{B\ org}+{}^{A}_{B}R{}^{B}P_{A\ org} = 0 \Rightarrow {}^{B}P_{A\ org} = -{}^{A}_{B}R{}^{T} {}^{A}P_{B\ org}$

  $$
  \Rightarrow {}^{A}_{B}T^{-1} =
  \begin{bmatrix}
  & {}^{A}_{B}R^{T} && -{}^{A}_{B}R{}^{T} {}^{A}P_{B\ org} \\
  0&0&0&1
  \end{bmatrix}
  $$

- 连续运算, 求未知相对关系
  待续

- 连续运算法则小结
  - $\{B\}$ 对 $\{A\}$ 的转轴旋转: 用左乘, "premultiply"
    对同一个向量,以同一个坐标为基准, 进行转动或移动的操作.
    Ex: $\{B\}$ 依序经过 $T_1$ , $T_2$, $T_3$ 三次变换
    ${}^{A}_{B}T = T_3 T_2 T_1 I$ , $ v^{\prime} = {}^{A}_{B}Tv = T_3 T_2 T_1 v$
  - $\{B\}$ 对 $\{B\}$ 自身的转轴旋转: 用右乘, "postmultiply"
    对某一个向量, 从最后一个坐标系"逐渐转动或移动"来回到第一个坐标系
    Ex: ${}^{A}_{B}T = I T_1 T_2 T_3 $ , ${}^{A}P = {}^{A}_{B}T{}^{B}P = I T_1 T_2 T_3 {}^{B}P $
