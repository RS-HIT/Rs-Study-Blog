# 4. 机械臂逆向运动学(Manipulator Inverse Kinematics)

- 机械臂顺向运动学 Forward Kinematics (FK)
  给予 $\theta_i$ (可计算出 ${}^{i-1}_{\quad i}T$ ), 求得 $\{H\}$ 或 ${}^{W}P$
  ${}^{W}_HT = f(\theta_1, \dots, \theta_i, \dots, \theta_n )$
  ${}^{W}P = {}^{W}_{H}T{}^{H}P$
- 机械臂逆向运动学 Inverse Kinematics (IK)
  给予 $\{H\}$ 或 ${}^{W}P$ , 求得 $\theta_i$ $[\theta_1, \dots, \theta_i, \dots, \theta_n] = f^{-1}({}^{W}_{H}T)$

## 4.1 求解概念

- 假设手臂有6个DOFs
  - 6个未知的joint anles ( $\theta_i$ 或 $d_i$ , $i=1, \dots, 6$ )
- 在 ${}^{W}_{H}T$ 中撷取出含未知数的 ${}^{0}_{6}T$, 16个数字
  $$
  {}^{0}_{6}T = 
  \begin{bmatrix}
  & {}^{0}_{6}R && {}^{0}P_{6 \ org} \\
  0&0&0&1
  \end{bmatrix}=
  \begin{bmatrix}
  |&|&|&| \\
  {}^{0}\hat{X}_6 & {}^{0}\hat{Y}_6 & {}^{0}\hat{Z}_6 & {}^{0}\hat{P}_{6 \ org}\\
  |&|&|&| \\
  0&0&0&1
  \end{bmatrix}
  $$

- 求解
  - 12个非线性超越方程式 (nonlinear transcendental equations)
  - 6个未知数, 6个限制条件
- Reachable Workspace
  - 手臂可以用一种以上的姿态到达的位置
- Dexterous workspace
  - 手臂可以用任何的姿态到达的位置
- Subspace
  - 手臂在定义头尾的T所能达到的变动范围

## 4.2 多重解

- 解的数目
  - 由于是非线性超越方程组, 6个未知数6个方程式不代表具有唯一解
  - 是由joint数目和link参数所决定
- 若具有多重解, 解的选择方式
  - 离目前状态最近的解
    - 最快
    - 最省能
    - ....
  - 避开障碍物

## 4.3 求解方法

- 解析法(Closed-form solutions)
  - 用 ==代数algebraic== 或 ==几何geometric方法==
- 数值法 Numerical solutions
- 目前大多机械臂设计成具有解析解
  - Pieper's solution: 相邻三轴相交一点

[例题](https://www.bilibili.com/video/BV1v4411H7ez?spm_id_from=333.788.player.switch&vd_source=7aa431eece1d1c0d38afe62a0e6d152f&p=28)

- 若6-DOF manipulator 具有3个连续的轴交在同一点, 则手臂有解析解
- Positioning structure(通过前3轴确定空间位置)
  - 法则: 让 $\theta_1$ , $\theta_2$ , $\theta_3$ 层层分离
    $$
    {}^{i-1}_{\quad i}T=
    \begin{bmatrix} c \theta_{i} & -s \theta_{i} & 0 & a_{i-1} \\
    s \theta_{i} c \alpha_{i-1}&c \theta_{i}c \alpha_{i-1}&-s \alpha_{i-1}&-s \alpha_{i-1}d_{i} \\ s \theta_{i}s \alpha_{i-1}&c \theta_{i}s \alpha_{i-1}&c \alpha_{i-1}&c \alpha_{i-1}d_{i} \\
    0&0&0&1
    \end{bmatrix}
    $$
    $\cos \theta_i = c\theta_i = c_i$
    $\sin \theta_i = s\theta_i = s_i$

    $$
    \begin{bmatrix}
    x \\ y \\ z \\1
    \end{bmatrix}=
    {}^{0}P_{4 \ ORG} = {}^0_1T{}^1_2T{}^2_3T\textcolor{green}{^3P_{4 \ ORG}}=
    {}_{1}^{0}T{}_{2}^{1}T{}_{3}^{2}T
    \textcolor{green}{
    \begin{bmatrix}
    a_{3}\\
    -d_{4}s\alpha_{3}\\
    d_{4}c\alpha_{3}\\
    1
    \end{bmatrix}}=
    {}_{1}^{0}T{}_{2}^{1}T
    \begin{bmatrix}f_{1}(\theta_{3})\\
    f_{2}(\theta_{3})\\
    f_{3}(\theta_{3})\\
    1
    \end{bmatrix}
    $$
    当机械臂结构确定后, 上式中绿色部分为常数.
    故

    $$
    \begin{bmatrix}
    f_{1} \left( \theta_{3} \right) \\ f_{2} \left( \theta_{3} \right) \\ f_{3} \left( \theta_{3} \right) \\ 1
    \end{bmatrix}=
    \begin{subarray}{c}
    2 \\ 3
    \end{subarray}T
    \left[ \begin{matrix}
    a_{3} \\ -d_{4}sa_{3} \\ d_{4}ca_{3} \\ 1
    \end{matrix} \right]
    $$
    让 $\theta_1$ , $\theta_2$ , $\theta_3$ 层层分离, $f$ 为 $\theta_3$ 的函数

    $$
    \begin{aligned}
    & f_1(\theta_3)=a_{3}c_{3}+d_{4}s\alpha_{3}s_{3}+a_{2} \\
    & f_2(\theta_3)=a_{3}c\alpha_{2}s_{3}-d_{4}s\alpha_{3}c\alpha_{2}c_{3}-d_{4}s\alpha_{2}c\alpha_{3}-d_{3}s\alpha_{2} \\
    & f_3(\theta_3)=a_{3}s\alpha_{2}s_{3}-d_{4}s\alpha_{3}s\alpha_{2}c_{3}+d_{4}c\alpha_{2}c\alpha_{3}+d_{3}c\alpha_{2}
    \end{aligned}
    $$
  - 下一步
    $$
    {}^{0}P_{4ORG}=
    \begin{bmatrix}
    x \\
    y \\
    z \\
    1
    \end{bmatrix}={}_{1}^{0}T ^{1}_{2}T
    \begin{bmatrix}
    f_{1}(\theta_{3}) \\
    f_{2}(\theta_{3}) \\
    f_{3}(\theta_{3}) \\
    1
    \end{bmatrix}={}_{1}^{0}T
    \begin{bmatrix}
    g_{1}(\theta_{2},\theta_{3}) \\
    g_{2}(\theta_{2},\theta_{3}) \\
    g_{3}(\theta_{2},\theta_{3}) \\
    1
    \end{bmatrix}=
    \begin{bmatrix}
    c_{1}g_{1}-s_{1}g_{2} \\
    s_{1}g_{1}+c_{1}g_{2} \\
    g_{3} \\
    1
    \end{bmatrix}
    $$
    让 $\theta_1$ , $\theta_2$ , $\theta_3$ 层层分离, $g$ 为 $\theta_2, \theta_3$ 的函数
    $$
    \begin{aligned}
    & g_{1}(\theta_{2},\theta_{3})=c_{2}f_{1}-s_{2}f_{2}+a_{1} \\
    & g_{2}(\theta_{2},\theta_{3})=s_{2}c\alpha_{1}f_{1}+c_{2}c\alpha_{1}f_{2}-s\alpha_{1}f_{3}-d_{2}s\alpha_{1} \\
    & g_{3}(\theta_{2},\theta_{3})=s_{2}s\alpha_{1}f_{1}+c_{2}s\alpha_{1}f_{2}+c\alpha_{1}f_{3}+d_{2}c\alpha_{1}
    \end{aligned}
    $$
    $$
    \begin{align*}
    r &= x^{2}+y^{2}+z^{2}=g_{1}^{2}+g_{2}^{2}+g_{3}^{2} \\
    &= f_{1}^{2}+f_{2}^{2}+f_{3}^{2}+a_{1}^{2}+d_{2}^{2}+2d_{2}f_{3}+2a_ {1}(c_{2}f_{1}-s_{2}f_{2}) \\
    &= (k_{1}c_{2}+k_{2}s_{2}) 2a_{1}+k_{3}
    \end{align*}
    $$
    其中
    $$
    \begin{aligned}
    & k_1(\theta_3)=f_{1} \\
    & k_2(\theta_3)=-f_{2} \\
    & k_3(\theta_3)=f_{1}^{2}+f_{2}^{2}+f_{3}^{2}+a_{1}^{2}+d_{2}^{2}+2d_{2}f_{3}
    \end{aligned}
    $$
    $r$ 仅为 $\theta_2$ , $\theta_3$ 的函数(消除了 $\theta_1$ )
    $k$ 仅与 $\theta_3$ 有关
  - 此外
    $z=g_{3}=(k_{1}s_{2}-k_{2}c_{2})s\alpha_{1}+k_{4}$ 
    其中
    $\begin{aligned}
    & k_1(\theta_3)=f_{1} \\
    & k_2(\theta_3)=-f_{2} \\
    & k_4(\theta_3)=f_{3}c\alpha_{1}+d_{2}c\alpha_{1}
    \end{aligned}$
    $z$ 仅为 $\theta_2$ , $\theta_3$ 的函数
  - 整合 $r$ 和 $z$ 一起考量
    $
    \begin{cases}
    r=(k_1c_2+k_2s_2)2a_1+k_3 \\
    z=(k_1s_2-k_2c_2)s\alpha_1+k_4 & 
    \end{cases}
    $
    - if $a_{1}=0,r=k_{3}(\theta_{3})=f_{1}^{2}+f_{2}^{2}+f_{3}^{2}+a_{1}^{2}+d_{2}^{2}+2d_{2}f_{3}$
    - if $s\alpha_{1}=0,z=k_{4}(\theta_{3})=f_{3}c\alpha_{1}+d_{2}c\alpha_{1}$
    - else $\frac{(r-k_{3})^{2}}{4a_{1}^{2}}+\frac{(z-k_{4})^{2}}{s^{2}\alpha_{1}}=k_{1}^{2}+k_{2}^{2}$
    解 $\theta_3$ 均可通过万能公式 $u=\tan(\frac{\theta_3}{2})$
  - 最后, 用 $r$ 和 $x$ 求解 $\theta_2$ 和 $\theta_1$
    $\begin{aligned}
    & r=(k_{1}c_{2}+k_{2}s_{2})2a_{1}+k_{3}\ \text{to solve }\textcolor{orange}{\theta_{2}} \\
    & x=c_{1}g_{1}(\theta_{2},\theta_{3})-s_{1}g_{2}(\theta_{2},\theta_{3}) \ \text{to solve }\textcolor{orange}{\theta_{1}}
    \end{aligned}$
  - 朝向(Orientation)
    - $\theta_1, \theta_2, \theta_3$ 已知
      ${}^{3}_{6}R = {}^{0}_{3}R^{-1} \, {}^{0}_{6}R$
    - 以 Z-Y-Z 欧拉角求解 $\theta_4, \theta_5, \theta_6$

[物件取放任务](https://www.bilibili.com/video/BV1v4411H7ez?vd_source=7aa431eece1d1c0d38afe62a0e6d152f&spm_id_from=333.788.videopod.episodes&p=32)